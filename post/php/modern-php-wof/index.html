<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Verdana's Notebook</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="http://phpvim.net/css/normalize.css">
    <link rel="stylesheet" href="http://phpvim.net/css/skeleton.css">
    <link rel="stylesheet" href="http://phpvim.net/css/style.css">
    <link rel="icon" type="image/png" href="http://phpvim.net/images/favicon.png">
</head>

<body>


    <div class="container">
        <header class="u-cf topinfo">
    <code><a href="http://phpvim.net/">@verdana</a></code>
    
    <code><span class="post-lastmod">2018, Apr 10</span></code>
    
    <code><span>Blogs </span><span class="post-count">11</span></code>
    <code><span>Views </span><span class="post-views">-</span></code>
</header>


        <article class="post-content">
            <h2 id="无框架编程">无框架编程</h2>

<p>读了来自 <a href="https://twitter.com/_KevinSmith">Kevin Smith</a> 的文章 <a href="https://kevinsmith.io/modern-php-without-a-framework">Modern PHP Without a Framework</a>，感觉很棒，这也是一直以来我个人追求的目标 —— 无框架 PHP 编程。</p>

<p>记得以前，想要脱离框架编写 Web 应用是比较麻烦的，很多东西需要自己来写，比如 <code>HTTP</code> 消息处理，路由，会话管理，权限校验，数据库操作等等。有了框架以后，我们就可以不关心这些，而把精力集中在业务逻辑上。</p>

<p></p>

<p>不同的框架针对的应用场景也是不同的，有大而全的 <a href="https://laravel.com">Laravel</a>, <a href="https://symfony.com">Symfony</a>, <a href="https://framework.zend.com">Zend Framework</a> 等等，基本上囊括了 Web 开发所需要的一切功能；如果只是想开发一个简单的应用，比如 Restful API 服务，也有类似 <a href="https://www.slimframework.com">Slim</a>，<a href="https://lumen.laravel.com">Lumen</a> 之类的精简框架；还有针对性能优化的使用 C 扩展作为核心的，比如 <a href="https://phalconphp.com">Phalcon</a>, <a href="https://github.com/laruence/yaf">Yaf</a> ；还有最近诞生的异步通信框架 <a href="http://swoole.com">Swoole</a> 等等。</p>

<p>还有很多流行的或者曾经流行过的框架没有列出来，在开发工作中，可以任意选择我们喜欢的框架来使用。我个人不是太喜欢框架，因为不管是哪种框架总有那么一些地方，功能不符合我的预期或者实现方式不那么优雅，让我觉得很别扭。如果说有个框架让我很满意，大概只有 Laravel 了。</p>

<p>换一个思路，如果我们只是想开发一个不那么复杂的应用，或许可以尝试抛弃框架。Kevin 的文章中作了尝试，但有很多地方没有讲清楚，有些地方还有错误，本文将把这个过程重新梳理一遍，重写样例代码，以作补充。</p>

<h2 id="如何实现">如何实现</h2>

<ul>
<li>感谢 <a href="https://www.php-fig.org">PHP-FIG</a>，有了很多基于 PSR 标准实现的简洁的组件，可以供我们选择。</li>
<li>感谢 <a href="https://getcomposer.org">Composer</a>，包管理器可以把需要的组件打包到一起以定制我们自己的框架。</li>
</ul>

<h2 id="从-frontcontroller-开始">从 FrontController 开始</h2>

<p>首先，什么是 <a href="https://en.wikipedia.org/wiki/Front_controller">Front Controller Design Pattern</a> 呢？</p>

<pre><code>The front controller design pattern means that all requests that come for a resource in an application will be handled by a single handler and then dispatched to the appropriate handler for that type of request.
</code></pre>

<p>简单的说，FrontController 是程序的入口，由上面的定义可以看出，FrontController 主要的功能是集中处理所有的客户端发来的请求，根据请求地址的不同，调用不用的控制器来处理，并将数据返回给客户端。</p>

<p>下面是一个极简版本的入口文件：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#000">$uri</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">isset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$_SERVER</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;PATH_INFO&#39;</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">$_SERVER</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;PATH_INFO&#39;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">$uri</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#ce5c00;font-weight:bold">:</span>
        <span style="color:#000">$controller</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;IndexController&#34;</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#39;/home&#39;</span><span style="color:#ce5c00;font-weight:bold">:</span>
        <span style="color:#000">$controller</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;HomeController&#34;</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span>
        <span style="color:#000">header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HTTP/1.1 404 Not Found&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">exit</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// 检查对应的 Controller 文件是否存在
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$controller</span> <span style="color:#ce5c00;font-weight:bold">.</span> <span style="color:#4e9a06">&#39;.php&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">file_exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$filename</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Controller file does not exists&#39;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// 载入控制器文件，然后初始化并运行
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">require_once</span> <span style="color:#000">$filename</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">$controller</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div>
<p>在实际的项目中，入口文件会变得复杂的多，比如上面的 <code>$uri</code> 检测，PHP 运行环境和配置千差万别，很多时候可能 <code>$_SERVER</code> 中不会有 <code>PATH_INFO</code> 或者值可能是错误的，这个时候我们就要同时检测 <code>$_SERVER['REQUEST_URI']</code> 和 <code>$_SERVER['PHP_SELF']</code> 等变量，以此算出正确的请求 URL。再者，还会有很多其它的功能参杂在一起，灰常的麻烦！</p>

<p>如果每一个项目中都要写一次上面的这样代码，肯定是很乏味的，所以才有了框架帮我们完成这些琐碎的工作，但是如果不依赖框架该怎么做更好呢？</p>

<p>下面就我们开始我们的无框架之旅，首先需要一些准备工作，搭建运行环境：</p>

<ul>
<li>安装 PHP 7.1，由于使用了一些新语法，所以版本不要低于 7.1</li>
<li>安装包管理器 Composer</li>
<li>创建我们的项目目录，比如 D:\Github\php-wof-skeleton</li>
<li>在项目目录中创建 public 和 src 目录，并创建文件 public/index.php</li>
<li>打开控制台，进入项目目录，运行命令 <code>php -S localhost:80 -t public/</code> 启动 PHP 的内置服务器</li>
</ul>

<p>好了，现在我们有了一个基本的 PHP 运行环境了。 :)</p>

<h3 id="自动加载技术以及第三方组件">自动加载技术以及第三方组件</h3>

<p>原文中有介绍，这里我们直接运行命令 <code>composer init</code> 创建配置文件 <code>composer.json</code>。</p>

<p>然后我们随便添加一个依赖包，比如 <code>monolog</code>：</p>

<pre><code>composer require monolog/monolog
</code></pre>

<p>这个命令会自动下载 <code>monolog</code>，你会看到项目下面多了一个 <code>vendor/</code> 目录和 <code>composer.lock</code>。</p>

<p>完成后打开 composer.json 加上 <code>autoload</code> 配置，大概是下面这个样子：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;verdana/php-wof-skeleton&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;description&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A simple boilerplate for php project&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;project&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;license&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;MIT&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;authors&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
        <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Verdana&#34;</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87;font-weight:bold">&#34;email&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;verdana.cn@gmail.com&#34;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">],</span>
    <span style="color:#204a87;font-weight:bold">&#34;minimum-stability&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;stable&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;require&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;monolog/monolog&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;^1.23&#34;</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#204a87;font-weight:bold">&#34;autoload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">&#34;psr-4&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">&#34;PhpWof\\&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;src/&#34;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p><code>autoload</code> 配置段的含义是，扫描 <code>src/</code> 目录下的所有类文件，使用 <code>Composer Autoload</code> 机制自动加载这些文件，PhpWof 是类的名字空间。</p>

<p>一些常用的命令：</p>

<ul>
<li><code>composer install</code> 下载所有的依赖包，包的版本受到 <code>composer.lock</code> 的限制，如果这个文件不存在，那么会根据 <code>minimum-stability</code> 的定义下载最新的版本，之后重新生成 <code>composer.lock</code> 锁定版本。</li>
<li><code>composer dump-autoload</code> 刷新 autoload 文件，重新生成 <code>class-map</code>。</li>
</ul>

<p>打开文件 <code>public/index.php</code>，引入 autoload 文件。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">require_once</span> <span style="color:#000">dirname</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__DIR__</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">.</span> <span style="color:#4e9a06">&#39;/vendor/autoload.php&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// 初始化 Monolog
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$log</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Monolog\Logger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;name&#39;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// 查看加载的文件
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">var_dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_included_files</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div>
<p>现在还没有任何功能，但是已经可以看到 autoload 加载了一些文件进来了，其中包括 Monolog 的一些文件。</p>

<p>OK，现在搞定了自动加载和如何引入第三方的组件，下面介绍依赖注入。</p>

<h3 id="什么是依赖注入">什么是依赖注入？</h3>

<pre><code>In software engineering, dependency injection is a technique whereby one object (or static method) supplies the dependencies of another object. A dependency is an object that can be used (a service). An injection is the passing of a dependency to a dependent object (a client) that would use it.
</code></pre>

<p>依赖注入是一种重要的解耦手段，通过控制反转来解决依赖性的设计模式。简单的说依赖注入也就是将类所依赖的对象在类的外部完成初始化，然后通过类的构造函数、属性或者方法传递给类。</p>

<p>来看一个不太好的例子：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">IndexController</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">$pdo</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">__construct</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">pdo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">\PDO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;pgsql:host=localhost;dbname=postgres&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;user&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;pass&#39;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
<p>很糟，控制器类完全的依赖 <code>PDO</code> 连接，如果数据库连接失败，后续的代码会完全停止运行。程序会运行一半后崩掉，很可能会显示给用户一个半残的页面，而且每一个控制器中可能都会有相同的代码，当然可以通过继承的方式解决，比如在父类中完成数据库连接，但是依然无法解决上面的问题，而且这些控制器因为依赖特定的数据库连接，其他人（比如 QA 人员）完全无法运行单元测试，除非他们也有一个和你一模一样的数据库以及用户密码。所以从职能上讲，这么做是很糟糕的。</p>

<p>上面的代码可能很傻，有经验的开发人员，大概不会写出这样的代码，但是我的确看到过很多比这更恐怖的&hellip;</p>

<p>让我们稍微的改进一下：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">IndexController</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">$pdo</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">__construct</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">\PDO</span> <span style="color:#000">$pdo</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">pdo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$pdo</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
<p>所有问题都解决了，数据库的连接被移到类的外部，只需要在初始化控制器的时候，将 <code>$pdo</code> 作为参数传入就可以了。其他人也可以通过模拟数据库连接进行单元测试，这样就与你的运行环境无关了。</p>

<p>实际项目中，控制器依赖的可能不只是数据库连接，可能还包括模板，服务以及一些工具类等等，这里我们就需要一个 <code>DI Container</code> 了，把这些被依赖的对象统统放入容器，在需要的时候自动初始化然后注入到控制器中。</p>

<h3 id="依赖注入容器">依赖注入容器</h3>

<p>目前最流行的是 <a href="http://php-di.org">PHP-DI</a>，打开控制台安装：</p>

<pre><code>composer require php-di/php-di
</code></pre>

<p>打开 <code>public/index.php</code>，更新下代码，首先需要配置容器：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">use</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">DI\create</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">use</span> <span style="color:#000">DI\ContainerBuilder</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">require_once</span> <span style="color:#000">dirname</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__DIR__</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">.</span> <span style="color:#4e9a06">&#39;/vendor/autoload.php&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">$builder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ContainerBuilder</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">useAutowiring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">useAnnotations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">addDefinitions</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000">PDO</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">create</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">constructor</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#4e9a06">&#39;pgsql:host=localhost;dbname=postgres&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;user&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;password&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">[]),</span>
<span style="color:#000;font-weight:bold">]);</span>

<span style="color:#000">$container</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">build</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">var_dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$container</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PDO</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div>
<p>关于 <code>autowire</code>，原文中有提到，这里再提一下，这个特性很好用，但是如果你的项目有多人维护或者你开发的项目是一个开源项目，那么最好<strong>明确的定义</strong>你需要注入的对象。因为 <code>PHP-DI</code> 使用 <a href="http://php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration">Type Hinting</a> 来实现自动注入，所以你需要声明注入方法（比如构造函数或者 set() 方法）的参数类型，通常有可能是一个 <code>interface</code> ，举个例子：<code>Psr\Http\Message\ResponseInterface</code>，然后问题就来了，如果其他人或者新引入的库中也实现了这个接口，那么 <code>PHP-DI</code> 就会无法判断到底该将哪个实现类与这个接口绑定，程序就会出现很多莫名其妙且很难调试的问题。所以说，应该慎用 <code>autowire</code>，明确定义更好一些。</p>

<p>当项目变得复杂以后，可能定义的对象会越来越多，还可以将其全部以数组的形式放在额外的文件中，以避免 <code>index.php</code> 变得臃肿。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">addDefinitions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;config.php&#39;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// config.php
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#8f5902;font-style:italic">// ....
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">];</span>
</code></pre></div>
<p>上面的例子中，容器会帮你自动初始化数据库连接，并注入到需要的类中，但是直接使用 <code>PDO</code> 不太好，使用一个连接管理类把它包装一下，处理连接异常等更好一些。</p>

<p>一个简单的数据库连接类，创建文件 <code>src/Database/Connection.php</code>，代码如下：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">declare</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">strict_types</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">namespace</span> <span style="color:#000">PhpWof\Database</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">use</span> <span style="color:#000">PDO</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">use</span> <span style="color:#000">PDOException</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Connection</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">$params</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">$options</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">$pdo</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">__construct</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">string</span> <span style="color:#000">$dsn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">string</span> <span style="color:#000">$user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">string</span> <span style="color:#000">$password</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">array</span> <span style="color:#000">$options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">params</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">$dsn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$password</span><span style="color:#000;font-weight:bold">];</span>
        <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">array</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">$options</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">empty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$options</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;lazy&#39;</span><span style="color:#000;font-weight:bold">]))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">connect</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">connect</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">void</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">pdo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">pdo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PDO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">params</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">params</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">params</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">options</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">pdo</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">setAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PDO</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">ATTR_ERRMODE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PDO</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">ERRMODE_EXCEPTION</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">PDOException</span> <span style="color:#000">$e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">$e</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">disconnect</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">void</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">pdo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getPDO</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PDO</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">pdo</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
<p>然后修改 <code>public/index.php</code> 中的定义。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">addDefinitions</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000">PhpWof\Database\Connection</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">create</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">constructor</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#4e9a06">&#39;pgsql:host=localhost;dbname=postgres&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;user&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;password&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">[]),</span>
<span style="color:#000;font-weight:bold">]);</span>
<span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span></code></pre></div>
<p>注入部分介绍到这里，目前的代码离真正的可用还有一段距离。我们还需要一个 <code>Router</code> 组件，有了路由才能将请求转发到控制器。在此之前，还要再介绍一个概念：Middleware，也就是中间件，这也是本文中除了 DI 以外最重要的部分。</p>

<h3 id="中间件">中间件</h3>

<p>在 Web 应用中，中间件通常是指在 <code>Request</code> 和 <code>Response</code> 的循环中按照顺序执行的实现各种功能的代码，整个中间件的执行过程是一个洋葱模型，如下图（网上扒来的）。</p>

<p><img src="http://phpvim.net/media/posts/modern-php-wof/onion.png" alt="洋葱模型" /></p>

<p>上图中有很多中间件，实际的工作中可能也会用到这么多，而要管理这些中间件按顺序正确的执行，就需要一个调度程序，也就是 <code>Dispatcher</code>（也叫做请求处理器，<code>Request Hander</code>）。调度程序以及所有的中间件都需要符合 <a href="https://www.php-fig.org/psr/psr-15">PSR-15</a> 标准，以求互相兼容。</p>

<p>安装 <a href="http://relayphp.com/2.x">Relay</a> 作为我们的调度器：</p>

<pre><code>composer require relay/relay:2.x@dev
</code></pre>

<p>如果你看过 <a href="https://www.php-fig.org/psr/psr-15">PSR-15</a>，里面有提到：</p>

<pre><code>A request handler is an individual component that processes a request and produces a response, as defined by PSR-7.
</code></pre>

<p>所以呢，我们还需要一个兼容 <a href="https://www.php-fig.org/psr/psr-7">PSR-7</a> 的 <code>HTTP</code> 消息处理组件，使用原文中推荐的 <a href="https://zendframework.github.io/zend-diactoros/">Zend Diactoros</a>。</p>

<pre><code>composer require zendframework/zend-diactoros
</code></pre>

<p>最后，我们还需要一个路由和请求处理程序，安装号称最快的路由 —— <a href="https://github.com/middlewares/fast-route">fast-route</a> 以及 <a href="https://github.com/middlewares/request-handler">request-handler</a>：</p>

<pre><code>composer require middlewares/fast-route middlewares/request-handler
</code></pre>

<p>fast-route 负责检查客户端请求是否符合路由定义的规则，并检测 URL 对应的控制器是否有效，然后 request-handler 负责启动控制器，并将 <code>Request</code> 对象传入控制器中。</p>

<p>然后，我们看一下如何让这些组件能够协同工作，打开 <code>public/index.php</code>，运作一番：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">require_once</span> <span style="color:#000">dirname</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__DIR__</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">.</span> <span style="color:#4e9a06">&#39;/vendor/autoload.php&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// 依赖注入
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$builder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DI\ContainerBuilder</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">useAutowiring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">useAnnotations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">addDefinitions</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000">PhpWof\Database\Connection</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">DI\create</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">constructor</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#4e9a06">&#39;pgsql:host=localhost;dbname=postgres&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;Verdana&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;postgres&#39;</span><span style="color:#000;font-weight:bold">),</span>
<span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">$container</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">build</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// 使用 fast-route 分配所有的请求
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$dispatcher</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">FastRoute\simpleDispatcher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">FastRoute\RouteCollector</span> <span style="color:#000">$r</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// $r-&gt;addRoute(&#39;GET&#39;, &#39;/&#39;, &#39;PhpWof\Controllers\IndexController&#39;);
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Relay 以及中间件
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$relay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Relay\Relay</span><span style="color:#000;font-weight:bold">([</span>
	<span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Middlewares\FastRoute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$dispatcher</span><span style="color:#000;font-weight:bold">),</span>
	<span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Middlewares\RequestHandler</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#000;font-weight:bold">]);</span>

<span style="color:#000">$response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$relay</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Zend\Diactoros\ServerRequestFactory</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">fromGlobals</span><span style="color:#000;font-weight:bold">());</span>

<span style="color:#8f5902;font-style:italic">// 输出
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Zend\Diactoros\Response\SapiEmitter</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">emit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$response</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div>
<blockquote>
<p>为了代码行数更短一些，去掉了所有名字空间导入语句 use xxx;</p>
</blockquote>

<p><code>ServerRequestFactory::fromGlobals()</code> 是一切的入口，这个函数从 <code>$_GET, $_POST, $_REQUEST, $_SESSION, $_COOKIE</code> 等这些全局数组中导入所有 <code>Request</code> 所必需的数据，</p>

<p><code>FastRoute</code> 和 <code>RequestHandler</code> 这两者的关系就好像是规则的制定者和执行者，你可以选择其它兼容 <code>PSR-15</code> 的类似组件，但是他们必须是存在的。</p>

<p>如果你在代码中使用了 <code>header()</code>, <code>http_response_code()</code> 之类的函数，那就需要保证这些函数之前没有任何输出，否则如果没有在 <code>php.ini</code> 中打开输出缓冲，程序就会报错。使用 <code>SapiEmitter</code> 就能保证 <code>Response</code> 的状态码、消息头和内容主体能以正确的顺序输出到浏览器，其中更多的细节，可以参考这篇文章 <a href="https://framework.zend.com/blog/2017-09-14-diactoros-emitters.html">Emitting Responses with Diactoros</a>。</p>

<h2 id="业务逻辑">业务逻辑</h2>

<p>到这里整体的框架差不多都搭建完了，还有最重要的一点没有讲，业务逻辑该怎么写？</p>

<p>再一次，我们还要继续的完善 <code>public/index.php</code> 文件：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">require_once</span> <span style="color:#000">dirname</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__DIR__</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">.</span> <span style="color:#4e9a06">&#39;/vendor/autoload.php&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// 依赖注入
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$builder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DI\ContainerBuilder</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">useAutowiring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">useAnnotations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">addDefinitions</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000">PhpWof\Database\Connection</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">DI\create</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">constructor</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#4e9a06">&#39;pgsql:host=localhost;dbname=postgres&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;Verdana&#39;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#4e9a06">&#39;postgres&#39;</span><span style="color:#000;font-weight:bold">),</span>

    <span style="color:#000">Psr\Http\Message\ResponseInterface</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Zend\Diactoros\Response</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">$container</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$builder</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">build</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// 使用 fast-route 分配所有的请求
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$dispatcher</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">FastRoute\simpleDispatcher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">FastRoute\RouteCollector</span> <span style="color:#000">$r</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">$r</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">addRoute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;GET&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;PhpWof\Controllers\IndexController&#39;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// request handlers 容器
</span><span style="color:#8f5902;font-style:italic">// 这里的参数会被用来创建路由器配置的类实例，也就是各种控制器
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$requestHandlerContainer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Middlewares\Utils\RequestHandlerContainer</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000">$container</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PhpWof\Database\Connection</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">$container</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Psr\Http\Message\ResponseInterface</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">class</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">]);</span>

<span style="color:#8f5902;font-style:italic">// Relay 以及中间件
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$relay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Relay\Relay</span><span style="color:#000;font-weight:bold">([</span>
	<span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Middlewares\FastRoute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$dispatcher</span><span style="color:#000;font-weight:bold">),</span>
	<span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Middlewares\RequestHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$requestHandlerContainer</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">]);</span>

<span style="color:#000">$response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$relay</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Zend\Diactoros\ServerRequestFactory</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">fromGlobals</span><span style="color:#000;font-weight:bold">());</span>

<span style="color:#8f5902;font-style:italic">// 输出
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Zend\Diactoros\Response\SapiEmitter</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">emit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$response</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div>
<p>在 <code>PHP-DI</code> 的定义中，多创建了一个 <code>Response</code> 对象作为接口 <code>ResponseInterface</code> 的实现类。</p>

<p><code>RequestHandler</code> 则负责将 <code>RequestHandlerContainer</code> 容器中的 <code>Connection</code> 和 <code>Response</code> 对象作为参数传递给控制器的构造函数。</p>

<p>现在可以写一个控制器了，创建文件 <code>src/Controllers/IndexController.php</code>：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#8f5902;font-style:italic">&lt;?php</span>
<span style="color:#204a87;font-weight:bold">declare</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strict_types</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">namespace</span> <span style="color:#000">PhpWof\Controllers</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">use</span> <span style="color:#000">PhpWof\Database\Connection</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">use</span> <span style="color:#000">Psr\Http\Message\ResponseInterface</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">use</span> <span style="color:#000">Psr\Http\Message\ServerRequestInterface</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">IndexController</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">$connection</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">$response</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">__construct</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Connection</span> <span style="color:#000">$conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ResponseInterface</span> <span style="color:#000">$response</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">connection</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$conn</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$response</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">__invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ServerRequestInterface</span> <span style="color:#000">$request</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ResponseInterface</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// $_GET
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">var_dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$request</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">getQueryParams</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#8f5902;font-style:italic">// $_POST
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">var_dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$request</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">getParsedBody</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#8f5902;font-style:italic">// 路由参数
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">var_dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$request</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">getAttributes</span><span style="color:#000;font-weight:bold">());</span>

        <span style="color:#8f5902;font-style:italic">// 操作数据库
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">$pdo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">connection</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">getPDO</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">$sth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$pdo</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;SELECT version()&#39;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;version&#39;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">$version</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$sth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">\PDO</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#c4a000">FETCH_ASSOC</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">var_dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$version</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">response</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
<p>除了需要注意构造函数中的参数外，就是魔术方法 <code>__invoke</code> 必须声明返回值为 <code>ResponseInterface</code>，然后返回 <code>Response</code> 对象。</p>

<p>完整的代码，可以在 <a href="https://github.com/verdana/php-wof-skeleton">Github</a> 下载。</p>

<p>最后，如果想要加入模板引擎，比如 <code>Twig</code> <code>Plates</code>，该怎么做呢&hellip; 可以自己试试呢！</p>

<h3 id="该去哪里找组件">该去哪里找组件？</h3>

<ul>
<li>首先可以看看这里：<a href="https://github.com/middlewares/psr15-middlewares">https://github.com/middlewares/psr15-middlewares</a></li>
<li>或者 Composer 的仓库 <a href="https://packagist.org">https://packagist.org</a></li>
<li>善用 Google 搜索，试试关键字： <code>site:github.com PSR-15 middleware</code></li>
<li>去 <code>Symfony</code> <code>Zend</code> 的官方网站去碰碰运气</li>
<li>&hellip;</li>
</ul>

<p>好了，完了&hellip;</p>
        </article>

        <footer class="post-footer">
            
            <ul class="post-tags">
                
                <li>
                    <a href="http://phpvim.net/tags/php"> <span class="tag">PHP</span> </a>
                </li>
                
            </ul>
            
            <p class="post-copyright">
                本作品采用<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>进行许可。
            </p>
        </footer>

        
    </div>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-1900757-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
</html>

